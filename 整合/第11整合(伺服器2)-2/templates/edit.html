<!doctype html>
<html lang="zxx">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Title -->
    <title>趣書園</title>
    <!-- Google Fonts -->
    <link href="/static/css/css2-Cabinwght400500600700_swap.css" rel="stylesheet">
    <!-- Favicon -->
    <!-- Bootstrap Min CSS -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <!-- Animate Min CSS -->
    <link rel="stylesheet" href="/static/css/animate.min.css">
    <!-- FlatIcon CSS -->
    <link rel="stylesheet" href="/static/css/flaticon.css">
    <!-- Bootstrap Icon CSS -->
    <link rel="stylesheet" href="/static/css/bootstrap-icons.css">
    <!-- Font Awesome Min CSS -->
    <link rel="stylesheet" href="/static/css/fontawesome.min.css">
    <!-- Mean Menu CSS -->
    <link rel="stylesheet" href="/static/css/meanmenu.css">
    <!-- Magnific Popup Min CSS -->
    <link rel="stylesheet" href="/static/css/magnific-popup.min.css">
    <!-- Swiper Min CSS -->
    <link rel="stylesheet" href="/static/css/swiper.min.css">
    <!-- Owl Carousel Min CSS -->
    <link rel="stylesheet" href="/static/css/owl.carousel.min.css">
    <!-- Style CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- Responsive CSS -->
    <link rel="stylesheet" href="/static/css/responsive.css">
    <!-- 網頁icon -->
    <link rel="icon" href="/static/picture/定稿-黑白.png" type="image/png">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.6.0/js/bootstrap.bundle.min.js" integrity="sha384-VPpEQxZUB0R0AYi7gWj9cM5DULsQvA1wmoFJbiE1eRtKPdJ+Wh7eU5jWDX0uS0fE" crossorigin="anonymous"></script>
    <style>
        /* Add some basic styles for the loading overlay */
        .loading-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            color: #fff;
            text-align: center;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
    
        .loading-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }
    
        .dot {
            width: 15px;
            height: 15px;
            background-color: #89c7c0;
            border-radius: 50%;
            margin: 0 5px;
            animation: bounce 1.5s infinite;
        }
    
        .dot:nth-child(1) {
            animation-delay: 0s;
        }
    
        .dot:nth-child(2) {
            animation-delay: 0.3s;
        }
    
        .dot:nth-child(3) {
            animation-delay: 0.6s;
        }
    
        .dot:nth-child(4) {
            animation-delay: 0.9s;
        }
    
        .dot:nth-child(5) {
            animation-delay: 1.2s;
        }
    
        @keyframes bounce {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.5);
            }
        }
    </style>
</head>

<body>
    <!-- 訊息視窗 -->
    <div id="customModal" class="modal1">
        <div class="modal-content1">
          <span class="close-btn">&times;</span>
          <p>你確定要登出嗎？</p>
          <div class="modal-actions1">
            <button id="confirmBtn">確定</button>
            <button id="cancelBtn">取消</button>
          </div>
        </div>
      </div>
    <!-- Start Preloader Section -->
    <div class="preloader">
        <div class="spinner">
            <div class="double-bounce1"></div>
            <div class="double-bounce2"></div>
        </div>
    </div>
    <!-- End Preloader Section -->

    <!-- Loading overlay -->
    <div id="loading" class="loading-overlay">
        <div class="loading-dots">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
    </div>

    <!-- Start Navbar Section -->
    <div class="navbar-area">
        <div class="rainbow-responsive-nav">
            <div class="container">
                <div class="rainbow-responsive-menu">
                    <div class="logo">
                        <a href="/afterlogin_home">
                            <img src="/static/picture/logo.png" class="white-logo" alt="logo">
                            <img src="/static/picture/logo-black.png" class="black-logo" alt="logo">
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="rainbow-nav">
            <div class="container">
                <nav class="navbar navbar-expand-md navbar-light">
                    <a class="navbar-brand" href="/afterlogin_home">
                        <img src="/static/picture/logo.png" class="white-logo" alt="logo">
                        <img src="/static/picture/logo-black.png" class="black-logo" alt="logo">
                    </a>
                    <div class="collapse navbar-collapse mean-menu" id="navbarSupportedContent">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a href="/afterlogin_home" class="nav-link">故事集</a>
                            </li>
                            <li class="nav-item">
                                <a href="/myStory" class="nav-link">歷史創作</a>
                            </li>
                            <li class="nav-item">
                                <a href="/collection" class="nav-link">故事收藏</a>
                            </li>
                            <li class="nav-item">
                                <a href="/follow" class="nav-link">創作者追蹤</a>
                            </li>
                        </ul>
                        <div class="other-option">
                            <a class="default-btn" href="/creation_story">開始創作<span></span></a>
                        </div>

                        <!-- 使用者資料設定 -->
                        <div class="profile-icon">
                            <span class="username">{{username}}</span>
                            <a href="/user_profile">
                                <!-- 顯示用戶的頭像 -->
                                <img src="{{ lookavatar }}" alt="User Avatar" class="user-avatar" />
                            </a>
                        </div>
                        <!-- 使用者資料設定 -->

                        <!-- 登出 -->
                        <div class="profile-icon">
                            <a href="#" id="logout-button">
                                <i class="fa-solid fa-power-off fa-xl" style="color: #ffffff;"></i>
                            </a>
                        </div>
                        <!-- 登出 -->
                    </div>
                </nav>
            </div>
        </div>
    </div>
    <!-- End Navbar Section -->

    <!-- Start Page Title Section -->
    <div class="page-title-area">
        <div class="d-table">
            <div class="d-table-cell">
                <div class="container">
                    <div class="page-title-content">
                        <h2>創作故事</h2>
                        <ul>
                            <li><a href="/afterlogin_home">回首頁</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Page Title Section -->

    <!-- Start Contact Section -->
    <div class="contact-section section-padding">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="section-title">
                        <h6 class="sub-title">✦ Preview Story ✦</h6>
                        <h2>你對生成出來的故事滿意嗎?</h2>
                    </div>
                </div>
                {% if error_message %}
				<div class="alert alert-danger" role="alert">
					{{ error_message }}
				</div>
				{% endif %}
                <div class="col-lg-10 offset-lg-1">
                    <div class="contact-form">
                        <p class="form-message"></p>
                        <form id="save-form" action="/save-story" method="post">
                            <div class="story-header">
                                <div>
                                    <h4>故事名稱：{{ story_title }}</h4>
                                    <h4>故事類型：{{ story_kind }}</h4>
                                </div>
                                <div>
                                    <label>
                                        <span>是否公開</span>
                                        <input type="checkbox" name="isPublic" id = "openstate">
                                    </label>

                                    <script>
                                        document.getElementById('openstate').addEventListener('change', function() {
                                            var isPublic = this.checked;
                                            console.log('是否公開:', isPublic); // 用于调试
                                    
                                            // 你可以根据需要处理 isPublic 的值
                                        });
                                    </script>
                                </div>

                            </div>
                            
                            <br>
                            <h5>故事大綱</h5>
                            <div class="form-group">
                                <textarea name="message0" class="form-control" id="message0" cols="30" rows="4" disabled required placeholder="故事大綱">{{ story_detail }}</textarea>
                                <button type="button" class="default-btn generate-btn" id="generate-btn0">生成圖片<span></span></button>
                                <div class="image-placeholder" id="image-placeholder0">圖片</div>
                                <!-- 隐藏字段来保存图片文件名 -->
                                <input type="hidden" id="image-filenames0" name="image-filenames0">
                            </div>
                            
                            <div class="divider"></div>
                            <div class="row">
                                <div class="col-lg-12 col-md-12">
                                    <h5>第一段</h5>
                                    <div class="form-group">
                                        <textarea name="message1" class="form-control" id="message1" cols="30" rows="4" required="" placeholder="第一段">{{ array_story[0][1] }}</textarea>
                                        <button type="button" class="default-btn generate-btn" id="generate-btn1">生成圖片<span></span></button>
                                        <div class="image-placeholder" id="image-placeholder1">圖片</div>
                                        <!-- 隐藏字段来保存图片文件名 -->
                                        <input type="hidden" id="image-filenames1" name="image-filenames1">
                                    </div>
                                </div>

                                <div class="col-lg-12 col-md-12">
                                    <h5>第二段</h5>
                                    <div class="form-group">
                                        <textarea name="message2" class="form-control" id="message2" cols="30" rows="4" required="" placeholder="第二段">{{ array_story[1][1] }}</textarea>
                                        <button type="button" class="default-btn generate-btn" id="generate-btn2">生成圖片<span></span></button>
                                        <div class="image-placeholder" id="image-placeholder2">圖片</div>
                                        <!-- 隐藏字段来保存图片文件名 -->
                                        <input type="hidden" id="image-filenames2" name="image-filenames2">
                                    </div>
                                </div>

                                <div class="col-lg-12 col-md-12">
                                    <h5>第三段</h5>
                                    <div class="form-group">
                                        <textarea name="message3" class="form-control" id="message3" cols="30" rows="4" required="" placeholder="第三段">{{ array_story[2][1] }}</textarea>
                                        <button type="button" class="default-btn generate-btn" id="generate-btn3">生成圖片<span></span></button>
                                        <div class="image-placeholder" id="image-placeholder3">圖片</div>
                                        <!-- 隐藏字段来保存图片文件名 -->
                                        <input type="hidden" id="image-filenames3" name="image-filenames3">
                                    </div>
                                </div>

                                <div class="col-lg-12 col-md-12">
                                    <h5>第四段</h5>
                                    <div class="form-group">
                                        <textarea name="message4" class="form-control" id="message4" cols="30" rows="4" required="" placeholder="第四段">{{ array_story[3][1] }}</textarea>
                                        <button type="button" class="default-btn generate-btn" id="generate-btn4">生成圖片<span></span></button>
                                        <div class="image-placeholder" id="image-placeholder4">圖片</div>
                                        <!-- 隐藏字段来保存图片文件名 -->
                                        <input type="hidden" id="image-filenames4" name="image-filenames4">
                                    </div>
                                </div>

                                <div class="col-lg-12 col-md-12">
                                    <h5>第五段</h5>
                                    <div class="form-group">
                                        <textarea name="message5" class="form-control" id="message5" cols="30" rows="4" required="" placeholder="第五段">{{ array_story[4][1] }}</textarea>
                                        <button type="button" class="default-btn generate-btn" id="generate-btn5">生成圖片<span></span></button>
                                        <div class="image-placeholder" id="image-placeholder5">圖片</div>
                                        <!-- 隐藏字段来保存图片文件名 -->
                                        <input type="hidden" id="image-filenames5" name="image-filenames5">
                                    </div>
                                </div>

                                <script>
                                    $(document).ready(function() {
                                        $('.generate-btn').click(function() {
                                            var $button = $(this); // 当前按钮
                                            var $placeholder = $button.siblings('.image-placeholder'); // 对应的占位符
                                            var message = $button.siblings('textarea').val();
                                            
                                            // 更改占位符文本为“生成中...”
                                            $placeholder.text('生成中...');
                                            
                                            $.ajax({
                                                type: 'POST',
                                                url: '/ai-image',
                                                data: JSON.stringify({ message: message }),
                                                contentType: 'application/json',
                                                success: function(response) {
                                                    if (response.image_paths && response.image_paths.length > 0) {
                                                        var imagesHtml = '';
                                                        var filenames = [];
                                                        
                                                        response.image_paths.forEach(function(imageUrl) {
                                                            var filename = imageUrl.split('/').pop(); // 获取文件名
                                                            filenames.push(filename);
                                                            imagesHtml += '<img src="' + imageUrl + '" alt="生成的圖片" class="generated-image" style="max-width: 100%; height: auto; margin: 10px 0; cursor: pointer;">';
                                                        });
                                                        
                                                        console.log('Filenames:', filenames); // Debug: 查看 filenames
                                                        
                                                        // 更新隐藏字段值
                                                        $button.siblings('input[type="hidden"]').val(filenames.join(','));
                                                        
                                                        // 将占位符更新为生成的图片
                                                        $placeholder.html(imagesHtml);
                                                        
                                                        // Attach click event to open modal
                                                        $('.generated-image').off('click').on('click', function() {
                                                            $('#modalImage').attr('src', $(this).attr('src'));
                                                            $('#imageModal').modal('show');
                                                        });
                                                    }
                                                },
                                                error: function(error) {
                                                    console.log('Error:', error);
                                                    // 在发生错误时仍将占位符文本更改为“生成失败”
                                                    $placeholder.text('生成失败');
                                                }
                                            });
                                        });
                                    });
                                </script>
                                
                                  
                                <div class="col-lg-12 col-md-12">
                                    <div class="contact-btn">
                                        <button type="submit" class="default-btn submit-btn">儲存故事<span></span></button>
                                    </div>
                                </div>
                                
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div class="custom-shape-1">
            <img src="/static/picture/shape-1.png" alt="png img">
        </div>
        <div class="custom-shape-2">
            <img src="/static/picture/shape.png" alt="png img">
        </div>
    </div>
    <!-- End Contact Section -->

    <!-- Start Footer & Subscribe Section -->
    <section class="footer-subscribe-wrapper">

        <!-- Start Footer Section -->
        <div class="footer-area ptb-100">
            <div class="container">
                <div class="row">
                    <div class="col-lg-4 col-md-6 col-sm-6">
                        <div class="single-footer-widget">
                            <a class="footer-logo" href="#">
                                <img src="/static/picture/logo-black.png" class="black-logo" alt="logo">
                            </a>
                            <p>生成精彩的情節和對話，讓您的孩子在享受閱讀樂趣的同時，培養他們的創意思維和語言能力。<br>家長還可以與孩子共同參與創作，增進親子間的互動和交流。</p>
                            <ul class="footer-social">
                                <li>
                                    <a href="#"> <i class="fab fa-facebook-f"></i></a>
                                </li>
                                <li>
                                    <a href="#"> <i class="fab fa-twitter"></i></a>
                                </li>
                                <li>
                                    <a href="#"> <i class="fab fa-youtube"></i></a>
                                </li>
                                <li>
                                    <a href="#"> <i class="fab fa-linkedin"></i></a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="col-lg-2 col-md-6 col-sm-6">
                    </div>

                    <div class="col-lg-2 col-md-6 col-sm-6">
                        <div class="single-footer-widget">
                            <div class="footer-heading">
                                <h3>製作團隊-113202</h3>
                            </div>
                            <ul class="footer-quick-links">
                                <li><a href="about.html">陳　平</a></li>
                                <li><a href="classes.html">張　彤</a></li>
                                <li><a href="contact.html">林嘉珮</a></li>
                                <li><a href="privacy-policy.html">李佳祐</a></li>
                            </ul>
                        </div>
                    </div>

                    <div class="col-lg-4 col-md-6 col-sm-6">
                        <div class="single-footer-widget">
                            <div class="footer-heading">
                                <h3>聯絡資訊</h3>
                            </div>
                            <div class="footer-info-contact"> <i class="flaticon-phone-call"></i>
                                <h3>電話</h3>
                                <span><a href="tel:0802235678">080 707 555-321</a></span>
                            </div>
                            <div class="footer-info-contact"> <i class="flaticon-envelope"></i>
                                <h3>Email</h3>
                                <span><a href="mailto:113202y113@gmail.com">113202y113@gmail.com</a></span>
                            </div>
                            <div class="footer-info-contact"> <i class="flaticon-placeholder"></i>
                                <h3>地址</h3>
                                <span>台北商業大學-資訊管理系</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Footer Section -->
    </section>
    <!-- End Footer & Subscribe Section -->

    <!-- Start Copy Right Section -->
    <div class="copyright-area"></div>
    <!-- End Copy Right Section -->

    <!-- Start Go Top Section -->
    <div class="go-top">
        <i class="fas fa-chevron-up"></i>
        <i class="fas fa-chevron-up"></i>
    </div>
    <!-- End Go Top Section -->

    <!-- 模態框結構 -->
        <div class="modal fade" id="imageModal" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="imageModalLabel">圖片預覽</h5>
                    </div>
                    <div class="modal-body">
                        <img id="modalImage" src="" alt="生成的圖片" style="width: 100%;">
                    </div>
                </div>
            </div>
        </div>
    <!-- 模態框結構 -->

    <!-- jQuery Min JS -->
    <script src="/static/js/jquery.min.js"></script>
    <!-- Popper Min JS -->
    <script src="/static/js/popper.min.js"></script>
    <!-- Bootstrap Min JS -->
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <!-- Mean Menu JS -->
    <script src="/static/js/jquery.meanmenu.js"></script>
    <!-- Appear Min JS -->
    <script src="/static/js/jquery.appear.min.js"></script>
    <!-- CounterUp Min JS -->
    <script src="/static/js/jquery.waypoints.min.js"></script>
    <script src="/static/js/jquery.counterup.min.js"></script>
    <!-- Owl Carousel Min JS -->
    <script src="/static/js/owl.carousel.min.js"></script>
    <!-- Magnific Popup Min JS -->
    <script src="/static/js/jquery.magnific-popup.min.js"></script>
    <!-- Swiper Min JS -->
    <script src="/static/js/swiper.min.js"></script>
    <!-- WOW Min JS -->
    <script src="/static/js/wow.min.js"></script>
    <!-- Main JS -->
    <script src="/static/js/main.js"></script>

</body>

</html>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const logoutButton = document.querySelector("#logout-button");

        // 獲取模態框
        var modal = document.getElementById("customModal");

        // 獲取打開模態框的按鈕（假設你有一個按鈕來觸發模態框）
        var btn = document.getElementById("logout-button");

        // 獲取關閉按鈕
        var span = document.getElementsByClassName("close-btn")[0];

        // 當用戶點擊按鈕時打開模態框
        btn.onclick = function() {
        modal.style.display = "block";
        }

        // 當用戶點擊關閉按鈕時關閉模態框
        span.onclick = function() {
        modal.style.display = "none";
        }

        // 當用戶點擊模態框外部時關閉模態框
        window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
        }

        // 確定和取消按鈕的事件處理
        document.getElementById("confirmBtn").onclick = function() {
        // 在這裡處理確定登出的邏輯
        modal.style.display = "none";
        window.location.href = "/logout";
        }

        document.getElementById("cancelBtn").onclick = function() {
        modal.style.display = "none";
        }
    });
    document.addEventListener("DOMContentLoaded", function() {
                const form = document.getElementById("save-form");
                const loadingOverlay = document.getElementById("loading");

                form.addEventListener("submit", function() {
                    loadingOverlay.style.display = "flex"; // Show loading overlay when form is submitted
                });
            });
</script>